name: Builder

on:
  push:
    branches: ["**"]
    tags: ["v*"]
  pull_request:
    branches: ["**"]

env:
  GO_VERSION: "1.25"
  NODE_VERSION: "24"
  PNPM_VERSION: "10"
  APP_NAME: "NezordLauncher"

jobs:
  build-linux:
    name: Build Linux
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config libgtk-3-dev libwebkit2gtk-4.0-dev libayatana-appindicator3-dev upx

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install frontend dependencies
        run: pnpm install
        working-directory: frontend

      - name: Build Linux Binary
        run: wails build -clean -upx

      - name: Build AppImage
        run: |
          wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage

          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps

          cp build/bin/${{ env.APP_NAME }} AppDir/usr/bin/
          cp build/${{ env.APP_NAME }}.desktop AppDir/usr/share/applications/

          sed -i 's|Exec=/usr/bin/nezordlauncher|Exec=${{ env.APP_NAME }}|g' AppDir/usr/share/applications/${{ env.APP_NAME }}.desktop

          if [ -f build/appicon.png ]; then
            cp build/appicon.png AppDir/usr/share/icons/hicolor/256x256/apps/nezordlauncher.png
          fi

          ./linuxdeploy-x86_64.AppImage --appdir AppDir --output appimage
          mv ${{ env.APP_NAME }}*.AppImage build/bin/

      - name: Upload Linux Installers
        uses: actions/upload-artifact@v4
        with:
          name: linux-installers
          path: |
            build/bin/*.AppImage

  release:
    name: Create Release
    needs: [build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download Linux Artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux-installers
          path: artifacts/linux

      - name: Publish Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/linux/*
          draft: true
          prerelease: false
          generate_release_notes: true
